<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Service Rate</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">

<div class="container p-4 bg-white rounded shadow">
  <h2 class="mb-4">Service Rate Setup</h2>

  <div class="row">
    <!-- Left Column: Form -->
    <div class="col-md-5">
      <div class="mb-3">
        <label for="serviceType" class="form-label">Service Type</label>
        <select class="form-select" id="serviceType">
          <option selected disabled>Select vehicle</option>
        </select>
      </div>

      <div class="mb-3 row align-items-end">
        <div class="col">
          <label class="form-label">Distance From</label>
          <div class="input-group">
            <span class="input-group-text">km</span>
            <input type="number" class="form-control" id="fromKM" placeholder="From">
          </div>
        </div>
        <div class="col">
          <label class="form-label">Distance To</label>
          <div class="input-group">
            <span class="input-group-text">km</span>
            <input type="number" class="form-control" id="toKM" placeholder="To">
          </div>
        </div>
      </div>

      <div class="mb-3 row">
        <div class="col">
          <label class="form-label">Selling Rate (KM)</label>
          <div class="input-group">
            <span class="input-group-text">₱</span>
            <input type="number" class="form-control" id="sellingRate" placeholder="Selling per KM">
          </div>
        </div>
        <div class="col">
          <label class="form-label">SP Rate (KM)</label>
          <div class="input-group">
            <span class="input-group-text">₱</span>
            <input type="number" class="form-control" id="spRate" placeholder="SP per KM">
          </div>
        </div>
      </div>

      <div class="mb-3 row">
        <div class="col">
          <label class="form-label">Selling Drop Rate</label>
          <div class="input-group">
            <span class="input-group-text">₱</span>
            <input type="number" class="form-control" id="sellingDrop" placeholder="Drop Fee">
          </div>
        </div>
        <div class="col">
          <label class="form-label">SP Drop Rate</label>
          <div class="input-group">
            <span class="input-group-text">₱</span>
            <input type="number" class="form-control" id="spDrop" placeholder="SP Drop Fee">
          </div>
        </div>
      </div>

      <button onclick="saveServiceRate()" class="btn btn-success w-100" id="submitBtn">Add</button>
    </div>

    <!-- Right Column: Table -->
    <div class="col-md-7">
      <h5>Rate Matrix</h5>
      <div class="table-responsive">
        <table class="table text-center align-middle table-bordered">
          <thead class="table-light">
            <tr>
              <th rowspan="2">Distance (KM)</th>
              <th colspan="2">SELLING</th>
              <th colspan="2">SP</th>
              <th colspan="2">MARGIN</th>
              <th colspan="2">Actions</th>
            </tr>
            <tr>
              <th>Rate</th>
              <th>Drop</th>
              <th>Rate</th>
              <th>Drop</th>
              <th>Revenue</th>
              <th>%</th>
              <th>Delete</th>
              <th>Edit</th>
            </tr>
          </thead>
          <tbody id="rateTableBody">
            <!-- Dynamic rows will appear here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  let rateData = [];
  let currentFilteredData = []; // Store currently filtered data
  let editingRateId = null; // Use rate_id instead of index

  async function fetchServiceUnitRates() {
    try {
      const response = await fetch('https://tms.ehatid.co/api/getServiceUnitRate');
      if (!response.ok) throw new Error('Failed to fetch data');
      const data = await response.json();

      rateData = data;
      populateServiceTypeOptions(data);
    } catch (error) {
      console.error('Error fetching service unit rates:', error);
    }
  }

  function populateServiceTypeOptions(data) {
    const select = document.getElementById('serviceType');
    const sortedData = [...data].sort((a, b) => a.rate_id - b.rate_id);
    const seen = new Set();

    sortedData.forEach(item => {
      if (!seen.has(item.service_type)) {
        seen.add(item.service_type);
        const option = document.createElement('option');
        option.value = item.service_type;
        option.textContent = item.service_type;
        select.appendChild(option);
      }
    });
  }

  function populateRateTable(data) {
    const tbody = document.getElementById('rateTableBody');
    tbody.innerHTML = '';
    
    // Store the filtered data for edit operations
    currentFilteredData = data;

    data.forEach((item, index) => {
      const marginRevenue = item.selling_km_rate - item.sp_km_rate;
      const marginPercent = ((marginRevenue / item.sp_km_rate) * 100).toFixed(2);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.km_range_from} - ${item.km_range_to}</td>
        <td>₱${item.selling_km_rate}</td>
        <td>₱${item.selling_drop_rate}</td>
        <td>₱${item.sp_km_rate}</td>
        <td>₱${item.sp_drop_rate}</td>
        <td>₱${marginRevenue}</td>
        <td>${marginPercent}%</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteRate(${item.rate_id})">Delete</button>
        </td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editRate(${index})">Edit</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function isOverlappingRange(serviceType, fromKM, toKM, ignoreRateId = null) {
    return rateData.some((item) => {
      if (item.rate_id === ignoreRateId || item.service_type !== serviceType) return false;
      const existingFrom = item.km_range_from;
      const existingTo = item.km_range_to;
      return (
        (fromKM >= existingFrom && fromKM <= existingTo) ||
        (toKM >= existingFrom && toKM <= existingTo) ||
        (fromKM <= existingFrom && toKM >= existingTo)  
      );
    });
  }

  async function saveServiceRate() {
    const serviceType = document.getElementById("serviceType").value;
    const fromKM = parseFloat(document.getElementById("fromKM").value);
    const toKM = parseFloat(document.getElementById("toKM").value);
    const sellingRate = parseFloat(document.getElementById("sellingRate").value);
    const spRate = parseFloat(document.getElementById("spRate").value);
    const sellingDrop = parseFloat(document.getElementById("sellingDrop").value);
    const spDrop = parseFloat(document.getElementById("spDrop").value);

    if (
      !serviceType || isNaN(fromKM) || isNaN(toKM) ||
      isNaN(sellingRate) || isNaN(spRate) ||
      isNaN(sellingDrop) || isNaN(spDrop)
    ) {
      alert("Please fill in all fields.");
      return;
    }

    // Check for overlapping ranges
    if (isOverlappingRange(serviceType, fromKM, toKM, editingRateId)) {
      alert("Distance range overlaps with existing range for this service type.");
      return;
    }

    // Prepare rate object
    const rate = {
      service_type: serviceType,
      km_range_from: fromKM,
      km_range_to: toKM,
      selling_km_rate: sellingRate,
      selling_drop_rate: sellingDrop,
      sp_km_rate: spRate,
      sp_drop_rate: spDrop,
      account: "base_rate",
      status_active: true,
      date_active: "",
      date_inactive: "",
      remarks: ""
    };

    // Check if editing
    const isEditing = editingRateId !== null;
    if (isEditing) {
      rate.rate_id = editingRateId;
    }

    try {
      const response = await fetch(`https://tms.ehatid.co/api/${isEditing ? "editServiceUnitRate" : "addServiceUnitRate"}`, {
        method: isEditing ? "PUT" : "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(rate)
      });

      if (!response.ok) throw new Error(`${isEditing ? "Update" : "Save"} failed`);

      const result = await response.json();
      alert(`${isEditing ? "Updated" : "Saved"} successfully!`);

      // Refresh local data and UI
      if (isEditing) {
        // Find and update the item in rateData
        const index = rateData.findIndex(item => item.rate_id === editingRateId);
        if (index !== -1) {
          rateData[index] = { ...rate };
        }
        editingRateId = null;
      } else {
        // Add new item to rateData
        rateData.push(result.rate || rate);
      }

      document.getElementById("submitBtn").textContent = "Add";
      clearForm();

      // Refresh the table with current service type
      const filtered = rateData.filter(item => item.service_type === serviceType);
      populateRateTable(filtered);

    } catch (error) {
      console.error(error);
      alert(`Error ${isEditing ? "updating" : "saving"} rate.`);
    }
  }

  function editRate(filteredIndex) {
    // Get the item from the filtered data using the table index
    const item = currentFilteredData[filteredIndex];
    
    if (!item) {
      alert("Error: Unable to find the selected rate data.");
      return;
    }

    // Fill form fields with the selected row's data
    document.getElementById("serviceType").value = item.service_type;
    document.getElementById("fromKM").value = item.km_range_from;
    document.getElementById("toKM").value = item.km_range_to;
    document.getElementById("sellingRate").value = item.selling_km_rate;
    document.getElementById("spRate").value = item.sp_km_rate;
    document.getElementById("sellingDrop").value = item.selling_drop_rate;
    document.getElementById("spDrop").value = item.sp_drop_rate;

    // Set edit mode using rate_id
    editingRateId = item.rate_id;
    document.getElementById("submitBtn").textContent = "Update";
  }

  async function deleteRate(rateId) {
    if (confirm("Are you sure you want to delete this rate?")) {
      try {
        const response = await fetch(`https://tms.ehatid.co/api/deleteServiceUnitRate`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ rate_id: rateId })
        });

        if (!response.ok) throw new Error("Delete failed");

        alert("Rate deleted successfully!");
        
        // Remove from local data
        rateData = rateData.filter(item => item.rate_id !== rateId);
        
        // Refresh the table
        const selectedType = document.getElementById("serviceType").value;
        if (selectedType) {
          const filtered = rateData.filter(item => item.service_type === selectedType);
          populateRateTable(filtered);
        }
        
        // Clear form if we were editing the deleted item
        if (editingRateId === rateId) {
          clearForm();
        }
        
      } catch (error) {
        console.error("Error deleting rate:", error);
        alert("Error deleting rate.");
      }
    }
  }

  function clearForm(preserveServiceType = false) {
    if (!preserveServiceType) {
      document.getElementById("serviceType").value = '';
    }
    document.getElementById("fromKM").value = '';
    document.getElementById("toKM").value = '';
    document.getElementById("sellingRate").value = '';
    document.getElementById("spRate").value = '';
    document.getElementById("sellingDrop").value = '';
    document.getElementById("spDrop").value = '';
    editingRateId = null;
    document.getElementById("submitBtn").textContent = "Add";
  }

  document.getElementById('serviceType').addEventListener('change', function () {
    const selectedType = this.value;
    const filtered = rateData.filter(item => item.service_type === selectedType);
    populateRateTable(filtered);
    clearForm(true);
  });

  fetchServiceUnitRates();
</script>

</body>
</html>